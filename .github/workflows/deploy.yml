name: Deploy Dashboard to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  SERVER_HOST: 198.54.123.234
  SERVER_USER: root
  APP_NAME: dashboard
  APP_PORT: 8002
  DEPLOY_PATH: /opt/fpai/apps/dashboard

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: |
          pip install -r requirements.txt
          pytest test/ -v

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Deploy
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          ssh-keyscan $SERVER_HOST >> ~/.ssh/known_hosts

          ssh -i ~/.ssh/key $SERVER_USER@$SERVER_HOST << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            git pull origin main
            docker stop fpai-${{ env.APP_NAME }} || true
            docker rm fpai-${{ env.APP_NAME }} || true
            docker build -t fpai-${{ env.APP_NAME }} .
            docker run -d --name fpai-${{ env.APP_NAME }} \
              -p ${{ env.APP_PORT }}:${{ env.APP_PORT }} \
              -e REGISTRY_URL=http://${{ env.SERVER_HOST }}:8000 \
              -e ORCHESTRATOR_URL=http://${{ env.SERVER_HOST }}:8001 \
              --restart unless-stopped \
              fpai-${{ env.APP_NAME }}
            sleep 5
            curl -f http://localhost:${{ env.APP_PORT }}/health
          EOF
